<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnimeVerse | Stream Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --neon: #FF7B00; --bg: #0D0D12; --card: #181820; }
        body { background: var(--bg); color: #fff; font-family: 'Outfit', sans-serif; margin: 0; }
        .video-container { position: relative; width: 100%; aspect-ratio: 16/9; background: #000; overflow: hidden; border-radius: 12px; border: 1px solid rgba(255, 123, 0, 0.2); }
        #main-player { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
        
        /* Next/Prev & Download Buttons Style */
        .control-btn { background: var(--card); border: 1px solid #333; transition: 0.3s; padding: 10px; border-radius: 8px; font-weight: 600; font-size: 0.8rem; flex: 1; text-align: center; cursor: pointer; }
        .control-btn:hover:not(:disabled) { border-color: var(--neon); color: var(--neon); }
        .control-btn:disabled { opacity: 0.2; cursor: not-allowed; }
        .dl-special { background: var(--neon) !important; color: #000 !important; font-weight: 800; border: none !important; }

        .ep-card { background: var(--card); border-radius: 12px; overflow: hidden; border: 1px solid transparent; transition: 0.3s; cursor: pointer; display: flex; align-items: center; padding: 8px; gap: 12px; }
        .ep-card.active { border-color: var(--neon); background: rgba(255, 123, 0, 0.1); }
        .ep-img { width: 100px; aspect-ratio: 16/9; border-radius: 6px; object-fit: cover; background: #222; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-black text-[#FF7B00]">ANIMEVERSE</h1>
            <button onclick="history.back()" class="bg-[#181820] px-4 py-2 rounded-lg text-sm border border-gray-800">BACK</button>
        </div>

        <div class="grid lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2">
                <div class="video-container mb-4 shadow-2xl shadow-orange-900/20">
                    <div id="error-overlay" class="absolute inset-0 bg-black/90 hidden flex-col items-center justify-center p-6 text-center z-20">
                        <p class="text-[#FF7B00] font-bold text-xl mb-4">Episode Not Available Yet</p>
                        <p class="text-gray-400 text-sm">Hamare Telegram channel par check karein.</p>
                    </div>
                    <iframe id="main-player" src="" allowfullscreen></iframe>
                </div>

                <div class="flex flex-wrap gap-3 mb-6">
                    <button id="prev-btn" class="control-btn" onclick="changeEpisode(-1)">PREVIOUS</button>
                    <a id="dl-link" href="#" target="_blank" class="control-btn dl-special">ðŸ“¥ DOWNLOAD NOW</a>
                    <button id="next-btn" class="control-btn" onclick="changeEpisode(1)">NEXT EPISODE</button>
                </div>

                <div class="bg-[#181820] p-6 rounded-2xl border border-gray-800">
                    <h2 id="anime-title" class="text-xl font-bold mb-2">Loading Anime Details...</h2>
                    <p id="anime-desc" class="text-gray-400 text-sm leading-relaxed line-clamp-3">Fetching overview from TMDB...</p>
                </div>
            </div>

            <div class="lg:col-span-1">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-400 uppercase tracking-widest text-xs">Episodes</h3>
                    <select id="season-select" class="bg-[#181820] border border-gray-800 text-xs px-2 py-1 rounded" onchange="renderEpisodes(this.value)"></select>
                </div>
                <div id="ep-grid" class="space-y-3 max-h-[600px] overflow-y-auto pr-2">
                    </div>
            </div>
        </div>
    </div>

    <script>
        const csvURL = "https://docs.google.com/spreadsheets/d/1VLcid14lgDfdDvYzfJLpLsbgD_jpY1CGzutgpEGhZdA/export?format=csv";
        const tmdbKey = "eef0f9c16ca61d6c843e7d43ddc5e1d8";
        let animeData = [];
        let filteredEpisodes = [];
        let currentIndex = 0;
        let tmdbId = null;

        async function init() {
            const params = new URLSearchParams(window.location.search);
            const animeID = params.get('id');
            if(!animeID) return;

            // 1. Fetch TMDB Meta
            const query = animeID.replace(/-/g, ' ');
            const tmdbRes = await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${tmdbKey}&query=${query}`);
            const tmdbData = await tmdbRes.json();
            if(tmdbData.results?.[0]) {
                const item = tmdbData.results[0];
                tmdbId = item.id;
                document.getElementById('anime-title').innerText = item.name || item.title;
                document.getElementById('anime-desc').innerText = item.overview;
            }

            // 2. Fetch CSV Episodes
            const res = await fetch(csvURL);
            const text = await res.text();
            const rows = text.split('\n').slice(1);
            animeData = rows.map(r => {
                const c = r.split(',');
                return { id: c[0]?.trim(), name: c[1]?.trim(), url: c[2]?.trim(), bot: c[3]?.trim() };
            }).filter(item => item.id === animeID);

            // 3. Fill Seasons
            const seasons = [...new Set(animeData.map(e => e.name.split(' - ')[0]))];
            const select = document.getElementById('season-select');
            seasons.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s; opt.innerText = s.replace('S', 'Season ');
                select.appendChild(opt);
            });

            renderEpisodes(seasons[0]);
        }

        function renderEpisodes(season) {
            filteredEpisodes = animeData.filter(e => e.name.startsWith(season));
            const grid = document.getElementById('ep-grid');
            grid.innerHTML = "";

            filteredEpisodes.forEach((ep, i) => {
                const sNum = ep.name.match(/S(\d+)/)?.[1] || 1;
                const epNum = i + 1;
                
                const card = document.createElement('div');
                card.className = `ep-card ep-item-${i}`;
                card.innerHTML = `
                    <img id="img-${sNum}-${epNum}" class="ep-img" src="https://placehold.co/300x169/181820/FF7B00?text=EP+${epNum}">
                    <div class="flex-1">
                        <p class="text-[10px] text-[#FF7B00] font-bold">EPISODE ${epNum}</p>
                        <p id="name-${sNum}-${epNum}" class="text-xs font-semibold text-gray-200">Loading Title...</p>
                    </div>
                `;
                card.onclick = () => playEpisode(i);
                grid.appendChild(card);

                // Fetch Episode Image & Title from TMDB
                if(tmdbId) {
                    fetch(`https://api.themoviedb.org/3/tv/${tmdbId}/season/${sNum}/episode/${epNum}?api_key=${tmdbKey}`)
                        .then(r => r.json()).then(d => {
                            if(d.name) document.getElementById(`name-${sNum}-${epNum}`).innerText = d.name;
                            if(d.still_path) document.getElementById(`img-${sNum}-${epNum}`).src = `https://image.tmdb.org/t/p/w300${d.still_path}`;
                        }).catch(() => {
                             document.getElementById(`name-${sNum}-${epNum}`).innerText = "No Title Available";
                        });
                }
            });
            playEpisode(0);
        }

        function playEpisode(index) {
            currentIndex = index;
            const ep = filteredEpisodes[index];
            const player = document.getElementById('main-player');
            const error = document.getElementById('error-overlay');
            const dlBtn = document.getElementById('dl-link');

            // URL check
            if (!ep.url || ep.url.trim() === "" || ep.url.toLowerCase() === "error") {
                player.style.display = "none"; error.style.display = "flex";
            } else {
                player.style.display = "block"; error.style.display = "none";
                player.src = ep.url;
            }

            // Download Link update
            dlBtn.href = `https://t.me/verse1_8bot?start=${ep.bot}`;

            // Update UI
            document.querySelectorAll('.ep-card').forEach(c => c.classList.remove('active'));
            document.querySelector(`.ep-item-${index}`).classList.add('active');
            
            // Update Nav Buttons
            document.getElementById('prev-btn').disabled = (index === 0);
            document.getElementById('next-btn').disabled = (index === filteredEpisodes.length - 1);
        }

        function changeEpisode(step) {
            let next = currentIndex + step;
            if (next >= 0 && next < filteredEpisodes.length) {
                playEpisode(next);
                // Scroll into view
                document.querySelector(`.ep-item-${next}`).scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        init();
    </script>
</body>
</html>
