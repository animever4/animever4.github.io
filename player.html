<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnimeVerse | Stream</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --neon: #FF7B00; --bg: #0D0D12; --card: #181820; }
        body { background: var(--bg); color: #fff; font-family: 'Outfit', sans-serif; margin: 0; }
        .nav-text { font-weight: 900; font-size: 1.4rem; text-transform: uppercase; letter-spacing: -1px; }
        .video-container {
            position: relative; width: 100%; aspect-ratio: 16/9; 
            background: #000; overflow: hidden; border-radius: 12px;
            border: 1px solid rgba(255, 123, 0, 0.2);
        }
        #main-player { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; z-index: 1; }
        .player-controls { display: flex; gap: 8px; margin-top: 10px; margin-bottom: 20px; }
        .btn-ctrl { flex: 1; background: #181820; border: 1px solid #2d2d3a; color: #fff; padding: 10px; border-radius: 8px; font-size: 11px; font-weight: bold; text-align: center; cursor: pointer; text-transform: uppercase; }
        .btn-ctrl:hover { border-color: var(--neon); }
        .btn-download { background: var(--neon); color: #000; }
        .report-link { font-size: 10px; color: #ff4444; text-transform: uppercase; cursor: pointer; text-decoration: underline; }
        .ep-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .ep-card { background: var(--card); border-radius: 8px; overflow: hidden; border: 1px solid transparent; transition: 0.3s; cursor: pointer; }
        .ep-card.active { border-color: var(--neon); background: #1f1f2a; }
        .ep-img { width: 100%; aspect-ratio: 16/9; object-fit: cover; opacity: 0.6; }
        .active .ep-img { opacity: 1; }
        .ep-info { padding: 8px; display: flex; flex-direction: column; gap: 2px; }
        .ep-name { font-size: 10px; color: #fff; font-weight: 800; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.2; text-transform: uppercase; }
        .ep-num { color: var(--neon); font-size: 9px; font-weight: 900; }
        #error-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none; flex-direction: column;
            justify-content: center; align-items: center; z-index: 10;
        }
        .disclaimer { font-size: 9px; color: #555; line-height: 1.4; margin-top: 20px; text-align: justify; }
    </style>
</head>
<body>

    <nav class="p-4 flex justify-between items-center border-b border-white/5">
        <div class="nav-text">ANIME<span class="text-[#FF7B00]">VERSE</span></div>
        <a href="javascript:history.back()" class="bg-white/10 text-[10px] font-bold px-4 py-2 rounded uppercase">Back</a>
    </nav>

    <main class="p-4 max-w-5xl mx-auto">
        <div class="flex gap-4 mb-6">
            <img id="poster" src="" class="w-24 h-36 rounded-lg object-cover border border-white/10">
            <div class="flex-1">
                <p class="text-[10px] text-[#FF7B00] font-bold uppercase mb-1">Anime Series</p>
                <h2 id="title" class="text-lg font-black uppercase mb-2 italic text-gray-200">Loading...</h2>
                <div class="flex items-center gap-3 text-[10px] font-bold text-gray-400 mb-2">
                    <span>HINDI</span> <span>HD</span> <span id="year">2024</span>
                </div>
                <p id="desc" class="text-[11px] text-gray-500 line-clamp-3">Fetching details...</p>
                <div onclick="reportIssue()" class="report-link mt-2">⚠️ Not Working? Report</div>
            </div>
        </div>

        <div class="video-container">
            <div id="error-overlay">
                <p class="text-white font-bold mb-2 text-sm uppercase">Episode Not Ready</p>
                <a id="error-dl-link" href="#" class="text-[10px] bg-[#FF7B00] text-black px-4 py-2 rounded font-black uppercase">Download Instead</a>
            </div>
            <iframe id="main-player" src="" scrolling="no" allowfullscreen></iframe>
        </div>

        <div class="player-controls">
            <button class="btn-ctrl" onclick="changeEp(-1)">Prev</button>
            <a id="dl-link" href="#" target="_blank" class="btn-ctrl btn-download">Download</a>
            <button class="btn-ctrl" onclick="changeEp(1)">Next</button>
        </div>

        <div class="flex justify-between items-center mb-5">
            <h3 class="text-xs font-black uppercase tracking-widest text-gray-400">SELECT EPISODE</h3>
            <select id="season-select" onchange="loadSeason(this.value)" class="bg-transparent text-[#FF7B00] font-bold outline-none text-sm"></select>
        </div>

        <div id="ep-grid" class="ep-grid mb-12"></div>
    </main>

    <script>
        const csvURL = "https://docs.google.com/spreadsheets/d/1VLcid14lgDfdDvYzfJLpLsbgD_jpY1CGzutgpEGhZdA/export?format=csv";
        const tmdbKey = "eef0f9c16ca61d6c843e7d43ddc5e1d8";
        let allData = [];
        let filteredEpisodes = [];
        let currentIndex = 0;
        let tmdbId = ""; 
        let mainPosterURL = "";

        async function init() {
            const params = new URLSearchParams(window.location.search);
            const animeId = params.get('id') || "solo-leveling";
            const searchQuery = animeId.replace(/-/g, ' ');

            try {
                // Step 1: Try TMDB for Images
                const tmdbSearch = await fetch(`https://api.themoviedb.org/3/search/tv?api_key=${tmdbKey}&query=${searchQuery}`);
                const tmdbData = await tmdbSearch.json();
                
                if(tmdbData.results && tmdbData.results.length > 0) {
                    const r = tmdbData.results[0];
                    tmdbId = r.id;
                    mainPosterURL = "https://image.tmdb.org/t/p/w500" + r.poster_path;
                    document.getElementById('title').innerText = r.name;
                    document.getElementById('poster').src = mainPosterURL;
                    document.getElementById('desc').innerText = r.overview;
                    document.getElementById('year').innerText = r.first_air_date ? r.first_air_date.split('-')[0] : "2024";
                } else {
                    // Step 2: Fallback to Jikan API if TMDB fails
                    const jikanRes = await fetch(`https://api.jikan.moe/v4/anime?q=${searchQuery}&limit=1`);
                    const jikanData = await jikanRes.json();
                    if(jikanData.data[0]) {
                        const a = jikanData.data[0];
                        mainPosterURL = a.images.jpg.large_image_url;
                        document.getElementById('title').innerText = a.title;
                        document.getElementById('poster').src = mainPosterURL;
                        document.getElementById('desc').innerText = a.synopsis;
                        document.getElementById('year').innerText = a.year || "2024";
                    }
                }
            } catch(e){ console.log("Init Error"); }

            // Load CSV
            const cr = await fetch(csvURL);
            const ct = await cr.text();
            const rows = ct.split('\n').slice(1);
            allData = rows.map(r => {
                const c = r.split(',');
                return { id: c[0]?.trim(), name: c[1]?.trim(), url: c[2]?.trim(), bot: c[3]?.trim() };
            }).filter(x => x.id === animeId);

            const seasons = [...new Set(allData.map(x => x.name.split(' - ')[0]))];
            const sel = document.getElementById('season-select');
            sel.innerHTML = seasons.map(s => `<option value="${s}">${s.replace('S', 'Season ')}</option>`).join('');
            
            if(seasons.length > 0) loadSeason(seasons[0]);
        }

        async function loadSeason(sName) {
            filteredEpisodes = allData.filter(x => x.name.startsWith(sName));
            const grid = document.getElementById('ep-grid');
            grid.innerHTML = "";
            const sNum = sName.replace(/\D/g, ''); // Extract only numbers

            filteredEpisodes.forEach((ep, i) => {
                const epNum = i + 1;
                const card = document.createElement('div');
                card.className = "ep-card";
                card.id = `card-${i}`;
                card.innerHTML = `
                    <img id="img-${sNum}-${epNum}" src="${mainPosterURL}" class="ep-img">
                    <div class="ep-info">
                        <span class="ep-name" id="name-${sNum}-${epNum}">Episode ${epNum}</span>
                        <span class="ep-num">${sNum}x${epNum}</span>
                    </div>
                `;
                card.onclick = () => selectEpisode(i);
                grid.appendChild(card);

                // Fetch Episode Thumbnail from TMDB
                if(tmdbId) {
                    fetch(`https://api.themoviedb.org/3/tv/${tmdbId}/season/${sNum}/episode/${epNum}?api_key=${tmdbKey}`)
                        .then(r => r.json()).then(d => {
                            if(d.still_path) document.getElementById(`img-${sNum}-${epNum}`).src = "https://image.tmdb.org/t/p/w300" + d.still_path;
                            if(d.name) document.getElementById(`name-${sNum}-${epNum}`).innerText = d.name;
                        }).catch(()=>{});
                }
            });
            if(filteredEpisodes.length > 0) selectEpisode(0);
        }

        function selectEpisode(index) {
            currentIndex = index;
            const ep = filteredEpisodes[index];
            const player = document.getElementById('main-player');
            const error = document.getElementById('error-overlay');
            
            if (!ep.url || ep.url.trim() === "" || ep.url.toLowerCase() === "error") {
                player.style.display = "none";
                error.style.display = "flex";
            } else {
                player.style.display = "block";
                error.style.display = "none";
                player.src = ep.url;
            }

            const botLink = `https://t.me/verse1_8bot?start=${ep.bot}`;
            document.getElementById('dl-link').href = botLink;
            document.getElementById('error-dl-link').href = botLink;

            document.querySelectorAll('.ep-card').forEach(c => c.classList.remove('active'));
            document.getElementById(`card-${index}`).classList.add('active');
        }

        function changeEp(dir) {
            let nextIndex = currentIndex + dir;
            if(nextIndex >= 0 && nextIndex < filteredEpisodes.length) selectEpisode(nextIndex);
        }

        function reportIssue() {
            const ep = filteredEpisodes[currentIndex];
            window.open(`https://t.me/AnimesVerse_Official?text=Report: ${ep.id} - ${ep.name}`);
        }

        init();
    </script>
</body>
</html>
