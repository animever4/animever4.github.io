</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnimeVerse | Final UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --neon: #FF7B00; --bg: #0D0D12; --card-bg: #181c25; }
        body { background: var(--bg); color: #fff; font-family: 'Outfit', sans-serif; margin: 0; }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--neon); border-radius: 10px; }

        .back-btn {
            background: #1c1f26;
            border: 1px solid #2a2e38;
            border-radius: 10px;
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }
        .back-btn:active { transform: scale(0.9); background: #2a2e38; }

        .video-container { width: 100%; aspect-ratio: 16/9; background: #000; overflow: hidden; }
        iframe { width: 100%; height: 100%; border: none; }

        .server-btn {
            padding: 8px 16px;
            background: #1c1f26;
            border: 1px solid #2a2e38;
            color: #ccc;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.3s;
            letter-spacing: 0.5px;
        }
        .server-btn.active {
            background: var(--neon);
            color: #000;
            border-color: var(--neon);
            box-shadow: 0 4px 15px rgba(255, 123, 0, 0.3);
        }

        .ep-card { 
            background: var(--card-bg); 
            border: 1px solid rgba(255,255,255,0.05);
            transition: 0.2s;
        }
        .ep-card.active { 
            border-color: var(--neon);
            background: rgba(255, 123, 0, 0.05);
        }

        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23FF7B00'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
        }
    </style>
</head>
<body>

    <div class="max-w-4xl mx-auto">
        <div class="p-4 flex items-center justify-between">
            <button class="back-btn" onclick="history.back()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M15 18l-6-6 6-6"/></svg>
            </button>
            <div class="text-center">
                <h1 id="anime-title" class="text-sm font-bold uppercase tracking-widest text-gray-400">Loading...</h1>
            </div>
            <div class="w-10"></div>
        </div>

        <div class="video-container relative group">
            <iframe id="main-player" src="" allowfullscreen></iframe>
        </div>

        <div class="flex items-center gap-3 p-4 overflow-x-auto no-scrollbar border-b border-white/5 bg-[#0d0d12]">
            <button class="server-btn active">Server 1</button>
            <button class="server-btn">Server 2</button>
            <button class="server-btn">Server 3</button>
        </div>

        <div class="p-4">
            <div class="flex items-center justify-between mb-6">
                <select id="season-select" onchange="loadSeason(this.value)" class="bg-[#181c25] border border-white/10 text-white text-xs font-bold py-2.5 px-4 pr-10 rounded-xl outline-none focus:border-[#FF7B00] transition-all">
                </select>
                
                <div class="flex gap-2">
                    <button onclick="smartChange(-1)" class="w-10 h-10 flex items-center justify-center bg-[#181c25] rounded-xl border border-white/10 active:scale-90 transition-all">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M15 18l-6-6 6-6"/></svg>
                    </button>
                    <a id="dl-link" href="#" target="_blank" class="flex items-center gap-2 bg-[#FF7B00] text-black text-[11px] font-black px-5 py-2.5 rounded-xl uppercase tracking-wider active:scale-95 transition-all">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v4M7 10l5 5 5-5M12 15V3"/></svg>
                        Download
                    </a>
                    <button onclick="smartChange(1)" class="w-10 h-10 flex items-center justify-center bg-[#181c25] rounded-xl border border-white/10 active:scale-90 transition-all">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18l6-6-6-6"/></svg>
                    </button>
                </div>
            </div>

            <div id="ep-list" class="grid grid-cols-1 gap-3">
                </div>
        </div>
    </div>

    <script>
        const csvURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS1D4R3t-mSjWc-wA560XQ-n-Bv5IqgY8S_29_S59vB3482mX-vA5Xf-N9m21F-G7n-vA/pub?output=csv";
        let episodes = [];
        let seasons = [];
        let filteredEpisodes = [];
        let currentIndex = 0;
        let currentSeasonName = "";
        let tmdbId = "";

        async function init() {
            const params = new URLSearchParams(window.location.search);
            const animeId = params.get('id') || "solo-leveling";
            
            try {
                const res = await fetch(csvURL);
                const data = await res.text();
                const rows = data.split('\n').slice(1);
                
                episodes = rows.map(row => {
                    const cols = row.split(',');
                    return { id: cols[0], season: cols[1], ep: cols[2], url: cols[3], bot: cols[4], tmdb: cols[5]?.trim() };
                }).filter(e => e.id === animeId);

                if(episodes.length > 0) {
                    document.getElementById('anime-title').innerText = animeId.replace(/-/g, ' ');
                    tmdbId = episodes[0].tmdb;
                    seasons = [...new Set(episodes.map(e => e.season))];
                    const select = document.getElementById('season-select');
                    seasons.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s;
                        opt.innerText = s;
                        select.appendChild(opt);
                    });
                    loadSeason(seasons[0]);
                }
            } catch (e) { console.error("Data Load Error"); }
        }

        async function loadSeason(seasonName) {
            currentSeasonName = seasonName;
            filteredEpisodes = episodes.filter(e => e.season === seasonName);
            const grid = document.getElementById('ep-list');
            grid.innerHTML = '';
            
            filteredEpisodes.forEach((ep, i) => {
                const sNum = seasonName.replace(/\D/g, '');
                const epNum = ep.ep;
                const card = document.createElement('div');
                card.id = `card-${i}`;
                card.className = 'ep-card flex items-center gap-3 p-2 rounded-xl cursor-pointer';
                card.innerHTML = `
                    <div class="relative w-24 h-14 flex-shrink-0">
                        <img id="img-${sNum}-${epNum}" src="https://via.placeholder.com/150x84/181c25/ffffff?text=Loading..." class="w-full h-full object-cover rounded-lg border border-white/5">
                        <div class="absolute bottom-1 right-1 bg-black/80 px-1.5 rounded text-[10px] font-bold">EP ${epNum}</div>
                    </div>
                    <div class="flex-grow min-w-0">
                        <div id="name-${sNum}-${epNum}" class="text-xs font-semibold truncate text-gray-300 italic">Episode ${epNum}</div>
                    </div>
                `;
                card.onclick = () => selectEpisode(i);
                grid.appendChild(card);

                if(tmdbId) {
                    fetch(`https://api.themoviedb.org/3/tv/${tmdbId}/season/${sNum}/episode/${epNum}?api_key=your_api_key`)
                    .then(r => r.json()).then(d => {
                        if(d.still_path) document.getElementById(`img-${sNum}-${epNum}`).src = "https://image.tmdb.org/t/p/w300" + d.still_path;
                        if(d.name) document.getElementById(`name-${sNum}-${epNum}`).innerText = d.name;
                    }).catch(()=>{});
                }
            });
            selectEpisode(0);
        }

        function selectEpisode(index) {
            currentIndex = index;
            const ep = filteredEpisodes[index];
            document.getElementById('main-player').src = ep.url;
            
            // DOWNLOAD BUTTON LOGIC
            const params = new URLSearchParams(window.location.search);
            const animeId = params.get('id');
            const dlBtn = document.getElementById('dl-link');

            if (animeId === "frieren-beyond-journeys-end" && currentSeasonName === "Season 1") {
                dlBtn.href = "https://t.me/+gPx8UV0k7N0yNTVl";
            } else {
                dlBtn.href = `https://t.me/verse1_8bot?start=${ep.bot}`;
            }

            document.querySelectorAll('.ep-card').forEach(c => c.classList.remove('active'));
            const activeCard = document.getElementById(`card-${index}`);
            if(activeCard) {
                activeCard.classList.add('active');
                activeCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function smartChange(dir) {
            let nIdx = currentIndex + dir;
            if (nIdx >= 0 && nIdx < filteredEpisodes.length) {
                selectEpisode(nIdx);
            } else {
                let sIdx = seasons.indexOf(currentSeasonName) + dir;
                if (sIdx >= 0 && sIdx < seasons.length) {
                    document.getElementById('season-select').value = seasons[sIdx];
                    loadSeason(seasons[sIdx]).then(() => selectEpisode(dir === 1 ? 0 : filteredEpisodes.length - 1));
                }
            }
        }
        init();
    </script>
</body>
</html>
